<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prompta - AI Cold Email Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="app">
    <!-- Auth Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center">
      <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
        <div class="text-center mb-8">
          <h1 class="text-3xl font-bold text-gray-800">Prompta</h1>
          <p class="text-gray-500 mt-2">AI-Powered Cold Email Platform</p>
        </div>
        
        <div id="login-form">
          <h2 class="text-xl font-semibold mb-4">Sign In</h2>
          <input type="email" id="login-email" placeholder="Email" class="w-full p-3 border rounded-lg mb-3">
          <input type="password" id="login-password" placeholder="Password" class="w-full p-3 border rounded-lg mb-4">
          <button onclick="login()" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90">Sign In</button>
          <p class="text-center mt-4 text-gray-500">
            Don't have an account? <a href="#" onclick="showSignup()" class="text-purple-600 hover:underline">Sign Up</a>
          </p>
        </div>

        <div id="signup-form" class="hidden">
          <h2 class="text-xl font-semibold mb-4">Create Account</h2>
          <input type="text" id="signup-company" placeholder="Company Name" class="w-full p-3 border rounded-lg mb-3">
          <input type="email" id="signup-email" placeholder="Email" class="w-full p-3 border rounded-lg mb-3">
          <input type="password" id="signup-password" placeholder="Password" class="w-full p-3 border rounded-lg mb-4">
          <button onclick="signup()" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90">Create Account</button>
          <p class="text-center mt-4 text-gray-500">
            Already have an account? <a href="#" onclick="showLogin()" class="text-purple-600 hover:underline">Sign In</a>
          </p>
        </div>

        <div id="auth-error" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg"></div>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard-screen" class="hidden">
      <!-- Header -->
      <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
          <h1 class="text-2xl font-bold text-gray-800">Prompta</h1>
          <div class="flex items-center gap-4">
            <span id="user-email" class="text-gray-600"></span>
            <button onclick="logout()" class="text-gray-500 hover:text-gray-700">Logout</button>
          </div>
        </div>
      </header>

      <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- SMTP Warning -->
        <div id="smtp-warning" class="hidden mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <p class="text-yellow-800">‚ö†Ô∏è Configure your SMTP to start sending emails. <a href="#" onclick="showTab('settings')" class="underline font-semibold">Set up now ‚Üí</a></p>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-4 gap-4 mb-8">
          <div class="bg-white p-6 rounded-xl shadow-sm">
            <p class="text-gray-500 text-sm">Total Leads</p>
            <p id="stat-leads" class="text-3xl font-bold text-gray-800">0</p>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-sm">
            <p class="text-gray-500 text-sm">Emails Sent</p>
            <p id="stat-sent" class="text-3xl font-bold text-gray-800">0</p>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-sm">
            <p class="text-gray-500 text-sm">Opens</p>
            <p id="stat-opened" class="text-3xl font-bold text-gray-800">0</p>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-sm">
            <p class="text-gray-500 text-sm">Replies</p>
            <p id="stat-replied" class="text-3xl font-bold text-green-600">0</p>
          </div>
        </div>

        <!-- Tabs -->
        <div class="flex border-b mb-6">
          <button onclick="showTab('leads')" class="tab-btn px-4 py-2 border-b-2 border-purple-600 text-purple-600 font-semibold" data-tab="leads">Leads</button>
          <button onclick="showTab('campaigns')" class="tab-btn px-4 py-2 text-gray-500 hover:text-gray-700" data-tab="campaigns">Campaigns</button>
          <button onclick="showTab('settings')" class="tab-btn px-4 py-2 text-gray-500 hover:text-gray-700" data-tab="settings">Settings</button>
        </div>

        <!-- Tab Content -->
        <div id="tab-leads" class="tab-content">
          <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-semibold">Your Leads</h2>
              <div class="flex gap-2">
                <button onclick="showFindLeads()" class="gradient-bg text-white px-4 py-2 rounded-lg">üîç Find Leads</button>
                <button onclick="showAddLeads()" class="text-gray-600 border px-4 py-2 rounded-lg text-sm">+ Manual Upload</button>
              </div>
            </div>
            
            <!-- Find Leads Form (PRIMARY) -->
            <div id="find-leads-form" class="hidden mb-6 p-6 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg border border-indigo-100">
              <h3 class="font-semibold mb-1 text-lg">üéØ Tell us who you want to reach</h3>
              <p class="text-gray-500 text-sm mb-4">We'll find qualified leads and their contact info automatically.</p>
              
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Industry / Business Type</label>
                  <input id="find-industry" type="text" class="w-full p-3 border rounded-lg" placeholder="e.g. Restaurants, Real Estate, E-commerce">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                  <input id="find-location" type="text" class="w-full p-3 border rounded-lg" placeholder="e.g. Dubai, UAE or Beirut, Lebanon">
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Job Title (optional)</label>
                  <input id="find-title" type="text" class="w-full p-3 border rounded-lg" placeholder="e.g. Owner, CEO, Marketing Manager">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">How many leads?</label>
                  <select id="find-count" class="w-full p-3 border rounded-lg">
                    <option value="25">25 leads</option>
                    <option value="50" selected>50 leads</option>
                    <option value="100">100 leads</option>
                    <option value="200">200 leads</option>
                  </select>
                </div>
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">What do you sell? (helps us personalize outreach)</label>
                <textarea id="find-pitch" rows="2" class="w-full p-3 border rounded-lg text-sm" placeholder="e.g. We build custom websites for restaurants with online ordering"></textarea>
              </div>
              <div class="flex gap-3">
                <button onclick="findLeads()" id="find-leads-btn" class="gradient-bg text-white px-6 py-2 rounded-lg font-medium">üöÄ Find Leads</button>
                <button onclick="hideFindLeads()" class="text-gray-500">Cancel</button>
              </div>
              <div id="find-leads-status" class="hidden mt-3 p-3 bg-white rounded border text-sm"></div>
            </div>
            
            <!-- Manual Add Form (secondary) -->
            <div id="add-leads-form" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
              <h3 class="font-semibold mb-3">Paste leads (one per line: email, firstName, lastName, company)</h3>
              <textarea id="leads-input" rows="6" class="w-full p-3 border rounded-lg font-mono text-sm" placeholder="john@company.com, John, Smith, Acme Inc&#10;jane@startup.io, Jane, Doe, StartupCo"></textarea>
              <div class="flex gap-3 mt-3">
                <button onclick="uploadLeads()" class="gradient-bg text-white px-4 py-2 rounded-lg">Upload Leads</button>
                <button onclick="hideAddLeads()" class="text-gray-500">Cancel</button>
              </div>
            </div>

            <table class="w-full">
              <thead>
                <tr class="text-left text-gray-500 text-sm border-b">
                  <th class="pb-3">Email</th>
                  <th class="pb-3">Name</th>
                  <th class="pb-3">Company</th>
                  <th class="pb-3">Status</th>
                </tr>
              </thead>
              <tbody id="leads-table"></tbody>
            </table>
            <p id="no-leads" class="text-gray-400 text-center py-8 hidden">No leads yet. Click "Find Leads" to get started.</p>
          </div>
        </div>

        <div id="tab-campaigns" class="tab-content hidden">
          <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-semibold">Campaigns</h2>
              <button onclick="showNewCampaign()" class="text-gray-600 border px-4 py-2 rounded-lg text-sm">+ Custom Campaign</button>
            </div>

            <!-- Auto-campaign explainer -->
            <div class="mb-6 p-4 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg border border-indigo-100">
              <p class="text-sm text-indigo-800">ü§ñ <strong>Campaigns are auto-generated</strong> when you find leads. We write the emails, personalize them, and have them ready to send. Just review and hit "Send."</p>
            </div>

            <!-- New Campaign Form (secondary ‚Äî for custom campaigns) -->
            <div id="new-campaign-form" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
              <h3 class="font-semibold mb-3">Custom Campaign</h3>
              <input id="campaign-name" placeholder="Campaign Name" class="w-full p-3 border rounded-lg mb-3">
              <input id="campaign-subject" placeholder="Email Subject (use {{firstName}}, {{company}} for personalization)" class="w-full p-3 border rounded-lg mb-3">
              <textarea id="campaign-body" rows="6" class="w-full p-3 border rounded-lg mb-3" placeholder="Email body (HTML supported, use {{firstName}}, {{company}} for personalization)"></textarea>
              <div class="flex gap-3">
                <button onclick="createCampaign()" class="gradient-bg text-white px-4 py-2 rounded-lg">Create Campaign</button>
                <button onclick="hideNewCampaign()" class="text-gray-500">Cancel</button>
              </div>
            </div>

            <div id="campaigns-list"></div>
            <p id="no-campaigns" class="text-gray-400 text-center py-8">No campaigns yet. Find leads first ‚Äî we'll auto-create your outreach campaign.</p>
          </div>
        </div>

        <div id="tab-settings" class="tab-content hidden">
          <div class="bg-white rounded-xl shadow-sm p-6">
            <h2 class="text-xl font-semibold mb-6">üìß Connect your email</h2>
            <p class="text-gray-500 mb-2">We'll send cold emails from your domain to build your reputation.</p>
            <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-6">
              <p class="text-amber-800 text-sm">‚ÑπÔ∏è <strong>Why we need this:</strong> Cold emails must come from YOUR domain to build sender reputation and ensure deliverability. We never share or store credentials beyond secure campaign execution.</p>
            </div>

            <!-- Provider Selector -->
            <label class="block text-sm font-medium text-gray-700 mb-2">Email Provider</label>
            <select id="smtp-provider" onchange="onProviderChange()" class="w-full p-3 border rounded-lg mb-4 bg-white">
              <option value="">‚Äî Select your provider ‚Äî</option>
              <option value="google">Google Workspace / Gmail</option>
              <option value="zoho">Zoho Mail</option>
              <option value="outlook">Microsoft 365 / Outlook</option>
              <option value="sendgrid">SendGrid</option>
              <option value="amazonses">Amazon SES</option>
              <option value="custom">Custom SMTP</option>
            </select>

            <!-- Provider Help (shown dynamically) -->
            <div id="provider-help" class="hidden mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800"></div>

            <div class="space-y-4">
              <!-- SMTP Host + Port (auto-filled, readonly for presets) -->
              <div class="grid grid-cols-3 gap-4">
                <div class="col-span-2">
                  <label class="block text-xs text-gray-500 mb-1">SMTP Host</label>
                  <input id="smtp-host" placeholder="smtp.gmail.com" class="w-full p-3 border rounded-lg bg-gray-50" readonly>
                </div>
                <div>
                  <label class="block text-xs text-gray-500 mb-1">Port</label>
                  <input id="smtp-port" placeholder="587" class="w-full p-3 border rounded-lg bg-gray-50" readonly>
                </div>
              </div>

              <!-- Email + Password -->
              <div>
                <label class="block text-xs text-gray-500 mb-1">Email / Username *</label>
                <input id="smtp-user" placeholder="outreach@yourcompany.com" class="w-full p-3 border rounded-lg">
              </div>
              <div>
                <label class="block text-xs text-gray-500 mb-1">Password / App Key *</label>
                <input id="smtp-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-3 border rounded-lg">
              </div>

              <!-- Sender Name -->
              <div>
                <label class="block text-xs text-gray-500 mb-1">Sender Name</label>
                <input id="smtp-sender" placeholder="John from Acme" class="w-full p-3 border rounded-lg">
              </div>
            </div>

            <div class="flex gap-3 mt-6">
              <button onclick="saveSMTP()" class="gradient-bg text-white px-6 py-3 rounded-lg font-medium">Save & Verify</button>
              <button onclick="testSMTP()" class="border border-purple-600 text-purple-600 px-6 py-3 rounded-lg font-medium">Send Test Email</button>
            </div>
            <div id="smtp-status" class="mt-4"></div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    const API = '';
    let token = localStorage.getItem('prompta_token');

    // Auth
    function showLogin() {
      document.getElementById('login-form').classList.remove('hidden');
      document.getElementById('signup-form').classList.add('hidden');
    }

    function showSignup() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('signup-form').classList.remove('hidden');
    }

    async function login() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      try {
        const res = await fetch(API + '/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (data.success) {
          token = data.token;
          localStorage.setItem('prompta_token', token);
          showDashboard(data.client);
        } else {
          showError(data.error);
        }
      } catch (e) { showError('Connection failed'); }
    }

    async function signup() {
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const companyName = document.getElementById('signup-company').value;
      try {
        const res = await fetch(API + '/api/auth/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, companyName })
        });
        const data = await res.json();
        if (data.success) {
          token = data.token;
          localStorage.setItem('prompta_token', token);
          showDashboard(data.client);
        } else {
          showError(data.error);
        }
      } catch (e) { showError('Connection failed'); }
    }

    function logout() {
      localStorage.removeItem('prompta_token');
      token = null;
      location.reload();
    }

    function showError(msg) {
      const el = document.getElementById('auth-error');
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    // Dashboard
    async function showDashboard(client) {
      document.getElementById('auth-screen').classList.add('hidden');
      document.getElementById('dashboard-screen').classList.remove('hidden');
      document.getElementById('user-email').textContent = client.email || client.companyName;
      
      if (!client.smtpConfigured) {
        document.getElementById('smtp-warning').classList.remove('hidden');
      } else {
        // Show SMTP as connected in Settings
        document.getElementById('smtp-warning').classList.add('hidden');
        const settingsTab = document.getElementById('tab-settings');
        if (settingsTab) {
          const connectedBanner = document.createElement('div');
          connectedBanner.className = 'mb-6 p-4 bg-green-50 border border-green-200 rounded-lg';
          connectedBanner.innerHTML = '<p class="text-green-800">‚úÖ <strong>Email connected:</strong> ' + (client.smtpEmail || client.email) + ' ‚Äî ready to send campaigns.</p>';
          settingsTab.querySelector('.bg-white').prepend(connectedBanner);
        }
      }
      
      loadStats();
      loadLeads();
      loadCampaigns();
    }

    async function loadStats() {
      const res = await fetch(API + '/api/dashboard', { headers: { Authorization: 'Bearer ' + token } });
      const data = await res.json();
      document.getElementById('stat-leads').textContent = data.stats.totalLeads;
      document.getElementById('stat-sent').textContent = data.stats.totalSent;
      document.getElementById('stat-opened').textContent = data.stats.totalOpened;
      document.getElementById('stat-replied').textContent = data.stats.totalReplied;
    }

    async function loadLeads() {
      const res = await fetch(API + '/api/leads', { headers: { Authorization: 'Bearer ' + token } });
      const data = await res.json();
      const tbody = document.getElementById('leads-table');
      const noLeads = document.getElementById('no-leads');
      
      if (data.leads.length === 0) {
        noLeads.classList.remove('hidden');
        tbody.innerHTML = '';
        return;
      }
      
      noLeads.classList.add('hidden');
      tbody.innerHTML = data.leads.map(l => `
        <tr class="border-b">
          <td class="py-3">${l.email || (l.website ? '<a href="'+l.website+'" target="_blank" class="text-purple-600 text-sm">üåê website</a>' : '<span class="text-gray-400 text-sm">enriching...</span>')}</td>
          <td class="py-3">${l.firstName || ''} ${l.lastName || ''}</td>
          <td class="py-3">${l.company || ''}</td>
          <td class="py-3">
            ${l.phone ? '<span class="text-sm text-gray-600">üìû '+l.phone+'</span>' : ''}
            <span class="ml-2 px-2 py-1 text-xs rounded-full ${l.status === 'sent' ? 'bg-green-100 text-green-700' : l.status === 'new' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}">${l.status}</span>
          </td>
        </tr>
      `).join('');
    }

    async function loadCampaigns() {
      const res = await fetch(API + '/api/campaigns', { headers: { Authorization: 'Bearer ' + token } });
      const data = await res.json();
      const list = document.getElementById('campaigns-list');
      const noCampaigns = document.getElementById('no-campaigns');
      
      if (data.campaigns.length === 0) {
        noCampaigns.classList.remove('hidden');
        list.innerHTML = '';
        return;
      }
      
      noCampaigns.classList.add('hidden');
      list.innerHTML = data.campaigns.map(c => `
        <div class="border rounded-lg p-4 mb-4 ${c.autoGenerated ? 'border-indigo-200 bg-indigo-50/30' : ''}">
          <div class="flex justify-between items-center mb-2">
            <div>
              <h3 class="font-semibold">${c.name} ${c.autoGenerated ? '<span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full ml-2">Auto-generated</span>' : ''}</h3>
              <p class="text-sm text-gray-500 mt-1">Subject: <strong>${c.subject}</strong></p>
            </div>
            <div class="flex items-center gap-3">
              ${c.status === 'sent' ? 
                `<span class="text-green-600 text-sm font-medium">‚úì Sent ${c.stats.sent}</span>` : 
                c.status === 'ready' || c.status === 'draft' ? 
                  `<button onclick="sendCampaign('${c.campaignId}')" class="gradient-bg text-white px-5 py-2 rounded-lg text-sm font-medium">üöÄ Send Campaign</button>` :
                  `<span class="text-gray-500 text-sm">${c.status}</span>`
              }
            </div>
          </div>
          <div class="mt-2 p-3 bg-white rounded border text-sm text-gray-600">
            <p class="text-xs text-gray-400 mb-1">Preview:</p>
            ${c.body ? c.body.substring(0, 200) + (c.body.length > 200 ? '...' : '') : ''}
          </div>
          ${c.stats.sent > 0 ? `
            <div class="flex gap-4 mt-3 text-xs text-gray-500">
              <span>üì§ Sent: ${c.stats.sent}</span>
              <span>üëÅ Opens: ${c.stats.opened || 0}</span>
              <span>üí¨ Replies: ${c.stats.replied || 0}</span>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    // Tabs
    function showTab(tab) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('border-b-2', 'border-purple-600', 'text-purple-600');
        el.classList.add('text-gray-500');
      });
      document.getElementById('tab-' + tab).classList.remove('hidden');
      document.querySelector(`[data-tab="${tab}"]`).classList.add('border-b-2', 'border-purple-600', 'text-purple-600');
    }

    // Leads
    function showFindLeads() { 
      document.getElementById('find-leads-form').classList.remove('hidden'); 
      document.getElementById('add-leads-form').classList.add('hidden');
    }
    function hideFindLeads() { document.getElementById('find-leads-form').classList.add('hidden'); }
    function showAddLeads() { 
      document.getElementById('add-leads-form').classList.remove('hidden');
      document.getElementById('find-leads-form').classList.add('hidden');
    }
    function hideAddLeads() { document.getElementById('add-leads-form').classList.add('hidden'); }

    async function findLeads() {
      const industry = document.getElementById('find-industry').value;
      const location = document.getElementById('find-location').value;
      const title = document.getElementById('find-title').value;
      const count = document.getElementById('find-count').value;
      const pitch = document.getElementById('find-pitch').value;

      if (!industry || !location) {
        alert('Please fill in industry and location at minimum.');
        return;
      }

      const btn = document.getElementById('find-leads-btn');
      const status = document.getElementById('find-leads-status');
      btn.disabled = true;
      btn.textContent = '‚è≥ Searching...';
      status.classList.remove('hidden');
      status.innerHTML = 'üîç Searching for ' + count + ' ' + industry + ' leads in ' + location + '...';

      try {
        const res = await fetch(API + '/api/leads/find', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
          body: JSON.stringify({ industry, location, title, count: parseInt(count), pitch })
        });
        const data = await res.json();
        if (data.success && data.leadsFound > 0) {
          status.innerHTML = '‚úÖ Found <strong>' + data.leadsFound + '</strong> leads! Campaign auto-created ‚Üí go to <a href="#" onclick="showTab(\'campaigns\')" class="text-purple-600 font-semibold underline">Campaigns</a> to review & send.';
          loadLeads();
          loadStats();
          loadCampaigns();
        } else if (data.success && data.message) {
          status.innerHTML = 'üîÑ ' + data.message;
        } else if (data.success) {
          status.innerHTML = 'üîÑ Your lead request is queued! Our AI is searching and verifying contacts for <strong>' + industry + '</strong> in <strong>' + location + '</strong>. You\'ll see leads appear within 1-2 hours.';
        } else {
          status.innerHTML = '‚ö†Ô∏è ' + (data.error || 'Search queued. Check back in a few hours.');
        }
      } catch (e) {
        status.innerHTML = 'üîÑ Lead request submitted! Our AI is finding leads for you. Check back in 1-2 hours.';
      }
      btn.disabled = false;
      btn.textContent = 'üöÄ Find Leads';
    }

    async function uploadLeads() {
      const input = document.getElementById('leads-input').value;
      const lines = input.trim().split('\n').filter(l => l.trim());
      const leads = lines.map(line => {
        const parts = line.split(',').map(p => p.trim());
        return { email: parts[0], firstName: parts[1], lastName: parts[2], company: parts[3] };
      });

      const res = await fetch(API + '/api/leads/upload', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
        body: JSON.stringify({ leads })
      });
      const data = await res.json();
      if (data.success) {
        alert(`Added ${data.added} leads!`);
        hideAddLeads();
        loadLeads();
        loadStats();
      }
    }

    // Campaigns
    function showNewCampaign() { document.getElementById('new-campaign-form').classList.remove('hidden'); }
    function hideNewCampaign() { document.getElementById('new-campaign-form').classList.add('hidden'); }

    async function createCampaign() {
      const name = document.getElementById('campaign-name').value;
      const subject = document.getElementById('campaign-subject').value;
      const body = document.getElementById('campaign-body').value;

      const res = await fetch(API + '/api/campaigns/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
        body: JSON.stringify({ name, subject, body })
      });
      const data = await res.json();
      if (data.success) {
        alert('Campaign created!');
        hideNewCampaign();
        loadCampaigns();
      }
    }

    async function sendCampaign(id) {
      if (!confirm('Send this campaign now?')) return;
      const res = await fetch(API + '/api/campaigns/' + id + '/send', {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + token }
      });
      const data = await res.json();
      if (data.success) {
        alert(`Sent ${data.sent} emails!`);
        loadCampaigns();
        loadStats();
      } else {
        alert('Error: ' + data.error);
      }
    }

    // SMTP Provider Presets
    const SMTP_PROVIDERS = {
      google: {
        host: 'smtp.gmail.com', port: '587',
        help: '‚ö†Ô∏è <strong>Google Workspace:</strong> You need an <a href="https://myaccount.google.com/apppasswords" target="_blank" class="underline">App Password</a>. Go to Google Account ‚Üí Security ‚Üí 2-Step Verification ‚Üí App Passwords. Use that as your password below.'
      },
      zoho: {
        host: 'smtp.zoho.com', port: '587',
        help: 'üîë <strong>Zoho:</strong> Use your Zoho email and password. If 2FA is enabled, generate an <a href="https://accounts.zoho.com/home#security/security_pwd" target="_blank" class="underline">App-Specific Password</a>.'
      },
      outlook: {
        host: 'smtp.office365.com', port: '587',
        help: 'üîë <strong>Microsoft 365:</strong> Use your email and password. If MFA is on, generate an <a href="https://mysignins.microsoft.com/security-info" target="_blank" class="underline">App Password</a>.'
      },
      sendgrid: {
        host: 'smtp.sendgrid.net', port: '587',
        help: 'üîë <strong>SendGrid:</strong> Username is always <code>apikey</code>. Password is your <a href="https://app.sendgrid.com/settings/api_keys" target="_blank" class="underline">SendGrid API Key</a>.'
      },
      amazonses: {
        host: 'email-smtp.us-east-1.amazonaws.com', port: '587',
        help: 'üîë <strong>Amazon SES:</strong> Create SMTP credentials in the <a href="https://console.aws.amazon.com/ses" target="_blank" class="underline">SES Console</a>. Region in the host must match your SES region.'
      },
      custom: {
        host: '', port: '',
        help: '‚öôÔ∏è Enter your SMTP server details manually.'
      }
    };

    function onProviderChange() {
      const sel = document.getElementById('smtp-provider').value;
      const hostEl = document.getElementById('smtp-host');
      const portEl = document.getElementById('smtp-port');
      const helpEl = document.getElementById('provider-help');

      if (sel && SMTP_PROVIDERS[sel]) {
        const p = SMTP_PROVIDERS[sel];
        hostEl.value = p.host;
        portEl.value = p.port;
        
        if (sel === 'custom') {
          hostEl.readOnly = false;
          portEl.readOnly = false;
          hostEl.classList.remove('bg-gray-50');
          portEl.classList.remove('bg-gray-50');
        } else {
          hostEl.readOnly = true;
          portEl.readOnly = true;
          hostEl.classList.add('bg-gray-50');
          portEl.classList.add('bg-gray-50');
        }

        helpEl.innerHTML = p.help;
        helpEl.classList.remove('hidden');
      } else {
        hostEl.value = '';
        portEl.value = '';
        helpEl.classList.add('hidden');
      }
    }

    // SMTP
    async function saveSMTP() {
      const host = document.getElementById('smtp-host').value;
      const port = document.getElementById('smtp-port').value;
      const user = document.getElementById('smtp-user').value;
      const pass = document.getElementById('smtp-pass').value;

      const res = await fetch(API + '/api/smtp/configure', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
        body: JSON.stringify({ host, port, user, pass, secure: true })
      });
      const data = await res.json();
      document.getElementById('smtp-status').innerHTML = data.success 
        ? '<p class="text-green-600">‚úì SMTP configured successfully!</p>'
        : '<p class="text-red-600">‚úó ' + data.error + '</p>';
      
      if (data.success) {
        document.getElementById('smtp-warning').classList.add('hidden');
      }
    }

    async function testSMTP() {
      const res = await fetch(API + '/api/smtp/test', {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + token }
      });
      const data = await res.json();
      document.getElementById('smtp-status').innerHTML = data.success
        ? '<p class="text-green-600">‚úì Test email sent! Check your inbox.</p>'
        : '<p class="text-red-600">‚úó ' + data.error + '</p>';
    }

    // Init
    async function init() {
      if (token) {
        try {
          const res = await fetch(API + '/api/me', { headers: { Authorization: 'Bearer ' + token } });
          const data = await res.json();
          if (data.email) {
            showDashboard(data);
          } else {
            localStorage.removeItem('prompta_token');
          }
        } catch { localStorage.removeItem('prompta_token'); }
      }
    }
    init();
  </script>
</body>
</html>
